<div class="min-h-screen bg-gray-50">
  <!-- Header -->
  <header class="bg-white shadow-sm border-b-2 border-gray-200 sticky top-0 z-10">
    <div class="max-w-md mx-auto px-4 py-4 flex items-center">
      <button (click)="goBack()" class="icon-btn mr-4">
        <mat-icon class="text-gray-700" style="width: 24px; height: 24px; font-size: 24px"
          >arrow_back</mat-icon
        >
      </button>
      <h1 class="text-xl font-bold text-gray-900">{{ 'medication.search' | transloco }}</h1>
      <div class="ml-auto relative">
        <button (click)="goToCart()" class="icon-btn relative">
          <mat-icon class="text-gray-700" style="width: 24px; height: 24px; font-size: 24px"
            >shopping_cart</mat-icon
          >
          @if (cartItems.size > 0) {
            <span
              class="absolute -top-1 -right-1 bg-red-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center"
            >
              {{ cartItems.size }}
            </span>
          }
        </button>
      </div>
    </div>
  </header>

  <!-- Search Bar -->
  <div class="bg-white border-b border-gray-200 sticky top-[73px] z-10">
    <div class="max-w-md mx-auto px-4 py-3">
      <div class="relative">
        <mat-icon
          class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
          style="width: 20px; height: 20px; font-size: 20px"
          >search</mat-icon
        >
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="onSearchInput()"
          [placeholder]="'medication.searchPlaceholder' | transloco"
          class="w-full pl-10 pr-10 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-900 focus:outline-none"
        />
        @if (searchTerm) {
          <button
            (click)="clearSearch()"
            class="absolute right-3 top-1/2 transform -translate-y-1/2"
          >
            <mat-icon class="text-gray-400" style="width: 20px; height: 20px; font-size: 20px"
              >close</mat-icon
            >
          </button>
        }
      </div>

      <!-- Filters -->
      <div class="flex gap-2 mt-3">
        <!-- Category Filter -->
        <select
          [(ngModel)]="selectedCategory"
          (change)="onCategoryChange()"
          class="flex-1 px-3 py-1.5 text-sm border border-gray-200 rounded-lg focus:border-blue-900 focus:outline-none"
        >
          @for (cat of categories; track cat.value) {
            <option [value]="cat.value">{{ cat.label }}</option>
          }
        </select>

        <!-- Prescription Toggle (Simplified for demo) -->
        <button
          (click)="togglePrescriptionFilter()"
          [class.bg-blue-900]="showPrescriptionOnly"
          [class.text-white]="showPrescriptionOnly"
          [class.bg-gray-100]="!showPrescriptionOnly"
          [class.text-gray-700]="!showPrescriptionOnly"
          class="px-3 py-1.5 text-sm font-medium rounded-lg transition-colors"
        >
          {{
            showPrescriptionOnly
              ? ('medication.prescriptionRequired' | transloco)
              : ('medication.prescriptionFree' | transloco)
          }}
        </button>
      </div>
    </div>
  </div>

  <!-- Content -->
  <div class="max-w-md mx-auto px-4 py-4">
    <!-- Loading State -->
    @if (loading) {
      <div class="flex justify-center items-center py-12">
        <div
          class="loading-spinner border-4 border-gray-200 border-t-blue-900 rounded-full h-8 w-8"
        ></div>
      </div>
    }

    <!-- Medications Grid -->
    @if (!loading && filteredMedications.length > 0) {
      <div class="space-y-3">
        @for (medication of filteredMedications; track medication.id) {
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <!-- Header with Name and Manufacturer -->
            <div class="flex justify-between items-start mb-2">
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <h3 class="font-semibold text-gray-900">{{ getMedicationName(medication) }}</h3>
                  @if (medication.prescription_required) {
                    <span
                      class="bg-red-50 text-red-700 px-1.5 py-0.5 rounded text-[10px] font-bold uppercase"
                      >RX</span
                    >
                  }
                </div>
                <p class="text-sm text-gray-600">{{ getManufacturer(medication) }}</p>
              </div>
            </div>

            <!-- Details -->
            <div class="text-sm text-gray-600 mb-3">
              <p>{{ 'medication.dosage' | transloco }}: {{ getForm(medication) }}</p>
              <p>{{ 'medication.packageSize' | transloco }}: {{ getAmount(medication) }}</p>
              <p class="text-xs text-gray-400 mt-1">PZN: {{ getPzn(medication) }}</p>
            </div>

            <!-- Footer with Price and Add to Cart -->
            <div class="flex justify-between items-center pt-3 border-t border-gray-100">
              <!-- Price and Availability -->
              <div>
                <p class="text-lg font-bold text-blue-900">
                  {{ getPrice(medication) | currency: 'EUR' : 'symbol' : '1.2-2' : 'de-DE' }}
                </p>
                @if (isAvailable(medication)) {
                  <p class="text-xs text-green-600">
                    {{ 'medication.available' | transloco }}
                  </p>
                } @else {
                  <p class="text-xs text-red-600">
                    {{ 'medication.notAvailable' | transloco }}
                  </p>
                }
              </div>

              <!-- Cart Controls -->
              @if (isAvailable(medication)) {
                <div class="flex items-center gap-2">
                  @if (medication.prescription_required) {
                    <div
                      class="text-[10px] font-bold text-red-700 bg-red-50 px-2 py-1 rounded uppercase border border-red-100"
                    >
                      Nur mit Rezept
                    </div>
                  } @else {
                    <!-- Quantity Controls (when item is in cart) -->
                    @if (getCartQuantity(medication.id) > 0) {
                      <div class="flex items-center">
                        <button (click)="removeFromCart(medication)" class="icon-btn-sm">
                          <mat-icon
                            class="text-gray-700"
                            style="width: 20px; height: 20px; font-size: 20px"
                            >remove</mat-icon
                          >
                        </button>
                        <input
                          type="text"
                          inputmode="numeric"
                          pattern="[0-9]*"
                          [value]="getCartQuantity(medication.id)"
                          (change)="updateQuantity(medication, $any($event.target).value)"
                          (keypress)="
                            (($event.charCode >= 48 && $event.charCode <= 57) ||
                              $event.charCode === 0)
                          "
                          min="0"
                          max="99"
                          class="w-12 text-center border border-gray-200 rounded mx-1 no-spinners"
                        />
                        <button (click)="addToCart(medication)" class="icon-btn-sm">
                          <mat-icon
                            class="text-gray-700"
                            style="width: 20px; height: 20px; font-size: 20px"
                            >add</mat-icon
                          >
                        </button>
                      </div>
                    } @else {
                      <!-- Add to Cart Button -->
                      <button (click)="addToCart(medication)" class="btn btn-primary btn-sm">
                        <mat-icon
                          class="mr-1 inline align-middle"
                          style="width: 16px; height: 16px; font-size: 16px"
                          >add_shopping_cart</mat-icon
                        >
                        {{ 'medication.addToCart' | transloco }}
                      </button>
                    }
                  }
                </div>
              } @else {
                <!-- Not Available Message -->
                <div class="text-sm text-gray-500">
                  {{ 'medication.notAvailable' | transloco }}
                </div>
              }
            </div>
          </div>
        }
      </div>
    }

    <!-- No Results -->
    @if (!loading && filteredMedications.length === 0) {
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 text-center mt-8">
        <mat-icon
          class="text-gray-400 mx-auto mb-4 block"
          style="width: 64px; height: 64px; font-size: 64px"
          >search_off</mat-icon
        >
        <h3 class="text-lg font-semibold text-gray-900 mb-2">
          {{ 'medication.noResults' | transloco }}
        </h3>
        <p class="text-sm text-gray-600 mb-4">
          {{ 'medication.tryDifferentSearch' | transloco }}
        </p>
        <button (click)="clearSearch()" class="btn btn-secondary">
          {{ 'medication.clearFilters' | transloco }}
        </button>
      </div>
    }
  </div>

  <!-- Floating Cart Button -->
  @if (cartItems.size > 0) {
    <button
      (click)="goToCart()"
      class="fixed bottom-20 right-4 bg-blue-900 text-white p-4 rounded-full shadow-lg hover:bg-blue-800 transition-all z-20"
    >
      <div class="flex items-center">
        <mat-icon style="width: 24px; height: 24px; font-size: 24px">shopping_cart</mat-icon>
        <span class="ml-2 font-semibold">{{ cartItems.size }}</span>
      </div>
    </button>
  }
</div>
